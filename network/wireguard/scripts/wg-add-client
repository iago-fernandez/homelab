#!/bin/bash

# Provisions a new WireGuard VPN client profile.
# Generates cryptographic keys, assigns an available IP address from the pool,
# registers the peer with the active interface, and outputs configuration files.

set -euo pipefail

# Enforce root privileges for interface manipulation
[ "$EUID" -eq 0 ] || exec sudo "$0" "$@"

name="${1:-}"
endpoint="${2:-}"

# Validate client name format
if [ -z "$name" ] || [[ ! "$name" =~ ^[A-Za-z0-9._-]+$ ]] || [[ "$name" == .* ]] || [[ "$name" == *".."* ]]; then
    echo "Usage: wg-add-client <name> [endpoint]"
    echo "Name must be alphanumeric."
    exit 1
fi

WG_DIR="/etc/wireguard"
SRV_IF="wg0"
SRV_CONF="$WG_DIR/$SRV_IF.conf"

[ -f "$SRV_CONF" ] || { echo "Critical: Configuration file $SRV_CONF not found."; exit 1; }
command -v wg >/dev/null || { echo "Critical: 'wg' utility not installed."; exit 1; }

# Resolve endpoint address
[ -z "$endpoint" ] && [ -f "$WG_DIR/WG_ENDPOINT" ] && endpoint="$(cat "$WG_DIR/WG_ENDPOINT")"
[ -z "$endpoint" ] && { echo "Error: Endpoint required (IP_or_Domain:Port)"; exit 1; }

# Retrieve server public key
srv_pub="$(wg show "$SRV_IF" public-key 2>/dev/null || true)"
[ -z "$srv_pub" ] && [ -f "$WG_DIR/keys/server.pub" ] && srv_pub="$(tr -d '\n' < "$WG_DIR/keys/server.pub")"
[ -z "$srv_pub" ] && { echo "Error: Unable to retrieve server public key."; exit 1; }

# Allocate the next available IP address within the defined subnet
used_ips="$(wg show "$SRV_IF" allowed-ips 2>/dev/null | awk '{sub(/\/32$/,"",$2);print $2}')"
for i in $(seq 2 254); do 
    target_ip="10.8.0.$i"
    if ! echo "$used_ips" | grep -qx "$target_ip"; then
        client_ip="$target_ip"
        break
    fi
done

[ -z "${client_ip:-}" ] && { echo "Error: IP pool exhausted in 10.8.0.0/24 subnet."; exit 1; }

# Initialize client configuration directory
client_dir="$WG_DIR/clients/$name"
install -d -m700 "$client_dir"
umask 077

# Generate asymmetric key pair and preshared key
wg genkey | tee "$client_dir/private.key" | wg pubkey > "$client_dir/public.key"
wg genpsk > "$client_dir/psk.key"

priv="$(cat "$client_dir/private.key")"
psk="$(cat "$client_dir/psk.key")"
pub="$(cat "$client_dir/public.key")"

# Register the new peer with the active WireGuard interface
wg set "$SRV_IF" peer "$pub" preshared-key "$client_dir/psk.key" allowed-ips "$client_ip/32"
wg-quick save "$SRV_IF" >/dev/null 2>&1 || true

# Write client configuration files
generate_config() {
    local mode=$1
    local file=$2
    local allowed_ips=$3
    
    cat >"$file"<<EOF
[Interface]
PrivateKey = $priv
Address = $client_ip/32
DNS = 10.8.0.1

[Peer]
PublicKey = $srv_pub
PresharedKey = $psk
Endpoint = $endpoint
AllowedIPs = $allowed_ips
PersistentKeepalive = 25
EOF
    chmod 600 "$file"
}

generate_config full "$client_dir/$name-full.conf" "0.0.0.0/0, ::/0"
generate_config split "$client_dir/$name-split.conf" "10.8.0.0/24, 192.168.1.0/24"

echo "Provisioning successful: Client '$name' assigned IP $client_ip."