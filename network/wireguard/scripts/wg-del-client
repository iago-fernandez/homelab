#!/bin/bash

# Revokes and removes an existing WireGuard VPN client profile.
# Unregisters the peer's public key from the active interface and purges
# the associated configuration directory.

set -euo pipefail

# Enforce root privileges for interface manipulation
[ "$EUID" -eq 0 ] || exec sudo "$0" "$@"

client_name="${1:-}"
[ -z "$client_name" ] && { echo "Usage: wg-del-client <name>"; exit 1; }

client_dir="/etc/wireguard/clients/$client_name"
[ -d "$client_dir" ] || { echo "Error: Client profile '$client_name' does not exist."; exit 1; }

# Extract public key and revoke peer access
pub_key="$(cat "$client_dir/public.key" 2>/dev/null || true)"
if [ -n "$pub_key" ]; then
    wg set wg0 peer "$pub_key" remove || true
    wg-quick save wg0 >/dev/null 2>&1 || true
fi

# Purge cryptographic keys and configuration files
rm -rf -- "$client_dir"
echo "Client '$client_name' successfully revoked and deleted."