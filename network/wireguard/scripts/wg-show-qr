#!/bin/bash

# Renders WireGuard client configurations as ANSI QR codes in the terminal
# to facilitate rapid provisioning of mobile devices.

set -euo pipefail

[ "$EUID" -eq 0 ] || exec sudo "$0" "$@"

client_name="${1:-}"
mode="${2:-both}"

[ -z "$client_name" ] && { echo "Usage: wg-show-qr <name> [both|full|split]"; exit 1; }
command -v qrencode >/dev/null || { echo "Error: 'qrencode' utility is required."; exit 1; }

file_full="/etc/wireguard/clients/$client_name/$client_name-full.conf"
file_split="/etc/wireguard/clients/$client_name/$client_name-split.conf"

# Display configuration via standard output and QR code
render_qr() {
    local label=$1
    local file=$2
    [ -f "$file" ] || { echo "Configuration file missing: $file"; return; }
    echo "Client Configuration: $client_name ($label)"
    qrencode -t ansiutf8 < "$file"
    echo
}

case "$mode" in
    full)  render_qr "Full Tunnel" "$file_full" ;;
    split) render_qr "Split Tunnel" "$file_split" ;;
    both)  
        render_qr "Full Tunnel" "$file_full"
        render_qr "Split Tunnel" "$file_split"
        ;;
    *) echo "Invalid mode. Valid options: both, full, split"; exit 1 ;;
esac